#!/command/with-contenv bashio
set -euo pipefail

APP_DIR=/opt/app

host=$(bashio::config 'host')
port=$(bashio::config 'port')
whisper_host=$(bashio::config 'whisper_host')
whisper_port=$(bashio::config 'whisper_port')
ha_url=$(bashio::config 'ha_url')
ha_token=$(bashio::config 'ha_token')
tts_prefix=$(bashio::config 'tts_prefix')

{
  echo "HOST=${host}"
  echo "PORT=${port}"
  echo "WHISPER_HOST=${whisper_host}"
  echo "WHISPER_PORT=${whisper_port}"
  echo "HOME_ASSISTANT_URL=${ha_url}"
  echo "HOME_ASSISTANT_TOKEN=${ha_token}"
  echo "TTS_PREFIX=${tts_prefix}"
} > "${APP_DIR}/.env"

# extra_env is list(str); write each non-empty line
while read -r kv; do
  [ -n "$kv" ] && echo "$kv" >> "${APP_DIR}/.env"
done < <(bashio::config 'extra_env[]' || true)

chmod 600 "${APP_DIR}/.env" || true
